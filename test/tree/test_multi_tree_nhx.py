#!/usr/bin/env python3

from brancharchitect.parser.newick_parser import parse_newick

# Multi-tree NHX string from the user's original question
multi_tree_nhx = """(LC769700:0.645538[&&NHX:LWR=0.141226:LLH=-1462.467500:alpha=0.521164],(LC769701:0.000002[&&NHX:LWR=0.049666:LLH=-1463.512537:alpha=1.000000],LC769681:0.010616[&&NHX:LWR=0.129363:LLH=-1462.555244:alpha=0.000000]):0.311787[&&NHX:LWR=0.079701:LLH=-1463.039582:alpha=0.571258],((((((LC769682:0.005049[&&NHX:LWR=0.004134:LLH=-1465.998702:alpha=1.000000],(((LC769689:0.000000[&&NHX:LWR=0.004134:LLH=-1465.998705:alpha=0.000000],LC769713:0.000000[&&NHX:LWR=0.004134:LLH=-1465.998705:alpha=0.000000]):0.000001[&&NHX:LWR=0.004134:LLH=-1465.998704:alpha=1.000000],LC769712:0.000001[&&NHX:LWR=0.004134:LLH=-1465.998704:alpha=1.000000]):0.000001[&&NHX:LWR=0.004134:LLH=-1465.998703:alpha=1.000000],LC769715:0.005068[&&NHX:LWR=0.004134:LLH=-1465.998703:alpha=1.000000]):0.000001[&&NHX:LWR=0.004134:LLH=-1465.998703:alpha=1.000000]):0.025721[&&NHX:LWR=0.007123:LLH=-1465.454485:alpha=1.000000],LC769706:0.000002[&&NHX:LWR=0.007081:LLH=-1465.460495:alpha=1.000000]):0.005090[&&NHX:LWR=0.010662:LLH=-1465.051185:alpha=1.000000],LC769709:0.000001[&&NHX:LWR=0.010683:LLH=-1465.049197:alpha=0.000000]):0.010228[&&NHX:LWR=0.011352:LLH=-1464.988438:alpha=0.499489],(((((((((((LC769683:0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000],LC769692:0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000]):0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000],LC769714:0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000]):0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000],LC769685:0.000000[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000]):0.000001[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=1.000000],LC769684:0.000001[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=1.000000]):0.000002[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=1.000000],LC769697:0.005087[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=1.000000]):0.005157[&&NHX:LWR=0.010057:LLH=-1465.109637:alpha=0.000000],LC769688:0.010191[&&NHX:LWR=0.006559:LLH=-1465.537092:alpha=1.000000]):0.005084[&&NHX:LWR=0.007104:LLH=-1465.457174:alpha=1.000000],(((LC769691:0.000000[&&NHX:LWR=0.007119:LLH=-1465.455063:alpha=0.000000],LC769698:0.000000[&&NHX:LWR=0.007119:LLH=-1465.455063:alpha=0.000000]):0.000000[&&NHX:LWR=0.007119:LLH=-1465.455063:alpha=0.000000],LC769699:0.000000[&&NHX:LWR=0.007119:LLH=-1465.455063:alpha=0.000000]):0.000001[&&NHX:LWR=0.007119:LLH=-1465.455064:alpha=1.000000],LC769695:0.000001[&&NHX:LWR=0.007119:LLH=-1465.455064:alpha=1.000000]):0.000001[&&NHX:LWR=0.007119:LLH=-1465.455072:alpha=1.000000]):0.000001[&&NHX:LWR=0.007119:LLH=-1465.455064:alpha=1.000000],((LC769694:0.000002[&&NHX:LWR=0.004803:LLH=-1465.848604:alpha=1.000000],LC769696:0.005078[&&NHX:LWR=0.004765:LLH=-1465.856556:alpha=1.000000]):0.010180[&&NHX:LWR=0.007158:LLH=-1465.449597:alpha=1.000000],LC769708:0.005079[&&NHX:LWR=0.007103:LLH=-1465.457283:alpha=1.000000]):0.000002[&&NHX:LWR=0.007119:LLH=-1465.455064:alpha=1.000000]):0.000002[&&NHX:LWR=0.007119:LLH=-1465.455061:alpha=1.000000],(((((LC769686:0.008164[&&NHX:LWR=0.024028:LLH=-1464.238631:alpha=0.000000],LC769711:0.010917[&&NHX:LWR=0.007618:LLH=-1465.387391:alpha=1.000000]):0.000002[&&NHX:LWR=0.007618:LLH=-1465.387392:alpha=0.000000],LC769687:0.005443[&&NHX:LWR=0.014125:LLH=-1464.769933:alpha=0.000000]):0.000003[&&NHX:LWR=0.007618:LLH=-1465.387394:alpha=1.000000],LC769710:0.002713[&&NHX:LWR=0.011542:LLH=-1464.971887:alpha=0.000000]):0.008180[&&NHX:LWR=0.007618:LLH=-1465.387394:alpha=0.000000],LC769690:0.000002[&&NHX:LWR=0.005415:LLH=-1465.728666:alpha=1.000000]):0.759181[&&NHX:LWR=0.006569:LLH=-1465.535489:alpha=0.284478],LC769693:0.000002[&&NHX:LWR=0.007156:LLH=-1465.449851:alpha=1.000000]):0.010132[&&NHX:LWR=0.007169:LLH=-1465.448071:alpha=0.363281]):0.005057[&&NHX:LWR=0.010669:LLH=-1465.050514:alpha=1.000000],LC769703:0.020646[&&NHX:LWR=0.016704:LLH=-1464.602245:alpha=0.000000]):0.000002[&&NHX:LWR=0.010685:LLH=-1465.049029:alpha=1.000000],(LC769704:0.015427[&&NHX:LWR=0.016766:LLH=-1464.598494:alpha=0.000000],LC769705:0.010289[&&NHX:LWR=0.015500:LLH=-1464.677015:alpha=0.000000]):0.000002[&&NHX:LWR=0.010685:LLH=-1465.049029:alpha=0.000000]):0.000003[&&NHX:LWR=0.010685:LLH=-1465.049029:alpha=1.000000]):0.005045[&&NHX:LWR=0.012818:LLH=-1464.866988:alpha=1.000000],LC769707:0.010297[&&NHX:LWR=0.013640:LLH=-1464.804826:alpha=0.493895]):0.010292[&&NHX:LWR=0.018332:LLH=-1464.509203:alpha=1.000000],LC769702:0.000002[&&NHX:LWR=0.018332:LLH=-1464.509203:alpha=0.000000]):0.111445[&&NHX:LWR=0.039472:LLH=-1463.742263:alpha=1.000000]);
(((LC769700:0.852408[&&NHX:LWR=0.000117:LLH=-2187.668838:alpha=1.000000],(LC769701:0.005195[&&NHX:LWR=0.000038:LLH=-2188.806762:alpha=1.000000],LC769681:0.000003[&&NHX:LWR=0.000038:LLH=-2188.806760:alpha=0.000000]):0.283952[&&NHX:LWR=0.000117:LLH=-2187.668838:alpha=1.000000]):0.235288[&&NHX:LWR=0.013129:LLH=-2182.952202:alpha=1.000000],((((((((((((((((LC769682:0.000000[&&NHX:LWR=0.013547:LLH=-2182.920881:alpha=0.000000],LC769713:0.000000[&&NHX:LWR=0.013547:LLH=-2182.920881:alpha=0.000000]):0.000001[&&NHX:LWR=0.013547:LLH=-2182.920881:alpha=0.000000],LC769712:0.000001[&&NHX:LWR=0.013547:LLH=-2182.920881:alpha=0.000000]):0.000001[&&NHX:LWR=0.013547:LLH=-2182.920881:alpha=0.000000],LC769715:0.005481[&&NHX:LWR=0.017961:LLH=-2182.638861:alpha=0.000000]):0.000001[&&NHX:LWR=0.013547:LLH=-2182.920880:alpha=1.000000],LC769689:0.002723[&&NHX:LWR=0.014564:LLH=-2182.848498:alpha=0.000000]):0.015462[&&NHX:LWR=0.013547:LLH=-2182.920884:alpha=0.000000],LC769702:0.040043[&&NHX:LWR=0.011286:LLH=-2183.103480:alpha=1.000000]):0.001285[&&NHX:LWR=0.011286:LLH=-2183.103490:alpha=0.000000],LC769707:0.028429[&&NHX:LWR=0.010995:LLH=-2183.129626:alpha=1.000000]):0.000001[&&NHX:LWR=0.010995:LLH=-2183.129627:alpha=0.000000],(LC769706:0.000001[&&NHX:LWR=0.003264:LLH=-2184.344207:alpha=1.000000],LC769709:0.005434[&&NHX:LWR=0.003266:LLH=-2184.343581:alpha=0.492188]):0.005533[&&NHX:LWR=0.010995:LLH=-2183.129627:alpha=1.000000]):0.002720[&&NHX:LWR=0.011378:LLH=-2183.095335:alpha=1.000000],LC769703:0.016761[&&NHX:LWR=0.011532:LLH=-2183.081930:alpha=0.499451]):0.000001[&&NHX:LWR=0.011378:LLH=-2183.095330:alpha=1.000000],LC769704:0.011040[&&NHX:LWR=0.011458:LLH=-2183.088376:alpha=0.499756]):0.005567[&&NHX:LWR=0.013640:LLH=-2182.914063:alpha=1.000000],LC769688:0.008420[&&NHX:LWR=0.015839:LLH=-2182.764559:alpha=0.000000]):0.002698[&&NHX:LWR=0.013640:LLH=-2182.914064:alpha=0.000000],LC769708:0.002717[&&NHX:LWR=0.012228:LLH=-2183.023321:alpha=1.000000]):0.000001[&&NHX:LWR=0.012228:LLH=-2183.023321:alpha=0.000000],LC769705:0.008253[&&NHX:LWR=0.014560:LLH=-2182.848778:alpha=0.000000]):0.002710[&&NHX:LWR=0.012228:LLH=-2183.023320:alpha=0.000000],((((LC769683:0.000001[&&NHX:LWR=0.013543:LLH=-2182.921161:alpha=0.000000],LC769697:0.000001[&&NHX:LWR=0.013543:LLH=-2182.921161:alpha=0.000000]):0.000001[&&NHX:LWR=0.013543:LLH=-2182.921161:alpha=1.000000],(((LC769684:0.000000[&&NHX:LWR=0.016134:LLH=-2182.746117:alpha=0.000000],LC769714:0.000000[&&NHX:LWR=0.016134:LLH=-2182.746117:alpha=0.000000]):0.000001[&&NHX:LWR=0.016134:LLH=-2182.746117:alpha=0.000000],LC769685:0.000001[&&NHX:LWR=0.016134:LLH=-2182.746117:alpha=0.000000]):0.002731[&&NHX:LWR=0.016692:LLH=-2182.712114:alpha=1.000000],LC769692:0.002749[&&NHX:LWR=0.016692:LLH=-2182.712118:alpha=1.000000]):0.002749[&&NHX:LWR=0.016692:LLH=-2182.712115:alpha=0.000000]):0.005461[&&NHX:LWR=0.013543:LLH=-2182.921162:alpha=0.000000],(LC769694:0.000001[&&NHX:LWR=0.008623:LLH=-2183.372592:alpha=0.000000],LC769696:0.000001[&&NHX:LWR=0.008623:LLH=-2183.372592:alpha=0.000000]):0.005443[&&NHX:LWR=0.009898:LLH=-2183.234689:alpha=1.000000]):0.000001[&&NHX:LWR=0.009898:LLH=-2183.234689:alpha=1.000000],LC769691:0.002713[&&NHX:LWR=0.011376:LLH=-2183.095516:alpha=0.000000]):0.002753[&&NHX:LWR=0.011373:LLH=-2183.095837:alpha=1.000000]):0.008394[&&NHX:LWR=0.011373:LLH=-2183.095837:alpha=0.000000],LC769693:0.002727[&&NHX:LWR=0.013084:LLH=-2182.955670:alpha=0.000000]):0.002733[&&NHX:LWR=0.011033:LLH=-2183.126171:alpha=1.000000],(LC769698:0.000001[&&NHX:LWR=0.011033:LLH=-2183.126164:alpha=0.000000],LC769699:0.000001[&&NHX:LWR=0.011033:LLH=-2183.126164:alpha=0.000000]):0.000001[&&NHX:LWR=0.011033:LLH=-2183.126163:alpha=1.000000]):0.002714[&&NHX:LWR=0.013130:LLH=-2182.952184:alpha=1.000000],LC769695:0.000001[&&NHX:LWR=0.013130:LLH=-2182.952156:alpha=0.000000]):0.000002[&&NHX:LWR=0.013130:LLH=-2182.952180:alpha=0.000000]):8.420741[&&NHX:LWR=0.318115:LLH=-2179.764634:alpha=0.358686],((LC769686:0.002474[&&NHX:LWR=0.000261:LLH=-2186.871901:alpha=0.000000],(LC769687:0.007638[&&NHX:LWR=0.000381:LLH=-2186.492007:alpha=1.000000],LC769690:0.005015[&&NHX:LWR=0.000382:LLH=-2186.488184:alpha=0.445557]):0.005057[&&NHX:LWR=0.000381:LLH=-2186.492004:alpha=0.000000]):0.000001[&&NHX:LWR=0.000238:LLH=-2186.964317:alpha=0.000000],LC769710:0.002475[&&NHX:LWR=0.000238:LLH=-2186.964312:alpha=1.000000]):0.002470[&&NHX:LWR=0.000238:LLH=-2186.964314:alpha=0.000000],LC769711:0.000002[&&NHX:LWR=0.000225:LLH=-2187.019936:alpha=1.000000]);;"""

print("Testing multi-tree NHX string...")
print(f"String length: {len(multi_tree_nhx)} characters")

try:
    trees = parse_newick(multi_tree_nhx, force_list=True)
    print("✅ SUCCESS: Multi-tree NHX string parsed successfully!")
    print(f"Number of trees: {len(trees)}")

    # Show stats for each tree
    for i, tree in enumerate(trees):

        def count_nodes_and_metadata(node):
            total_nodes = 1
            nodes_with_metadata = 1 if (hasattr(node, "values") and node.values) else 0

            for child in node.children:
                child_total, child_metadata = count_nodes_and_metadata(child)
                total_nodes += child_total
                nodes_with_metadata += child_metadata

            return total_nodes, nodes_with_metadata

        total_nodes, nodes_with_metadata = count_nodes_and_metadata(tree)
        print(
            f"  Tree {i + 1}: {total_nodes} nodes, {nodes_with_metadata} with NHX metadata"
        )

        # Show one sample metadata from this tree
        def show_one_sample(node):
            if hasattr(node, "values") and node.values:
                print(f"    Sample metadata: {node.values}")
                return True
            for child in node.children:
                if show_one_sample(child):
                    return True
            return False

        show_one_sample(tree)

except Exception as e:
    print(f"❌ FAILED: {e}")
    import traceback

    traceback.print_exc()
